RG_NAME="rg-ch05"
COSMOS_NAME="cosmosor2551"

az cosmosdb create --name $COSMOS_NAME --resource-group $RG_NAME


FUNC_STORAGE_NAME="storagefuncor2551"
APP_SERVICE_PLAN_NAME="planor2551"
FUNCTION_APP_NAME="funcor2551"

az storage account create --name $FUNC_STORAGE_NAME --resource-group $RG_NAME --location eastus --sku Standard_LRS 

az appservice plan create --resource-group $RG_NAME --name $APP_SERVICE_PLAN_NAME --sku S1 --location eastus

az functionapp create --resource-group $RG_NAME --name $FUNCTION_APP_NAME --storage-account $FUNC_STORAGE_NAME --assign-identity [system] --functions-version 3 --plan $APP_SERVICE_PLAN_NAME 


COSMOS_ID=$(az cosmosdb show --name $COSMOS_NAME --resource-group $RG_NAME --query id -o tsv)

FUNC_OBJECT_ID=$(az functionapp show --name $FUNCTION_APP_NAME --resource-group $RG_NAME --query identity.principalId --output tsv)


{
    "RoleName": "MyCosmosDBReadWriteRole",
    "Type": "CustomRole",
    "AssignableScopes": ["/"],
    "Permissions": 
    [
      {
        "DataActions": [
            "Microsoft.DocumentDB/databaseAccounts/readMetadata",
            "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/*",
            "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/*"            
        ]
      }
    ]
}

az cosmosdb sql role definition create --account-name $COSMOS_NAME --resource-group $RG_NAME --body "C:/Data/Repo/AzureCookbook/Chapter04/MyCosmosDBReadWriteRole.json"



MSYS_NO_PATHCONV=1 az cosmosdb sql role assignment create --account-name $COSMOS_NAME --resource-group $RG_NAME --role-definition-name MyCosmosDBReadWriteRole --principal-id $FUNC_OBJECT_ID --scope "/dbs"




